<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      margin: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 10px 20px;
      border: 1px solid #5e6ad2;
      background: #5e6ad2;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #4c5bc7;
    }
    
    #mindmap {
      width: 100%;
      height: 500px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    #log {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .log-item {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #5e6ad2;
      padding-left: 10px;
    }
    
    .log-item.success {
      border-left-color: #28a745;
      background: #d4edda;
    }
    
    .log-item.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }
    
    #preview {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    #preview img {
      max-width: 100%;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h1>
  
  <div id="controls">
    <button onclick="testSVGExport()">æµ‹è¯• SVG å¯¼å‡º</button>
    <button onclick="testPNGExport()">æµ‹è¯• PNG å¯¼å‡º</button>
    <button onclick="testMarkdownExport()">æµ‹è¯• Markdown å¯¼å‡º</button>
    <button onclick="downloadSVG()">ä¸‹è½½ SVG</button>
    <button onclick="downloadPNG()">ä¸‹è½½ PNG</button>
    <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
  </div>
  
  <svg id="mindmap"></svg>
  
  <div id="log"></div>
  
  <div id="preview"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="./packages/markmap-lib/dist/browser/index.iife.js"></script>
  <script src="./packages/markmap-view/dist/browser/index.js"></script>
  
  <script>
    let view;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const item = document.createElement('div');
      item.className = `log-item ${type}`;
      item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(item);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('preview').innerHTML = '';
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('load', async () => {
      try {
        log('åˆå§‹åŒ– Markmap...');
        
        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const { root } = transformer.transform(`
# å¯¼å‡ºæµ‹è¯•
## ç¬¬ä¸€ç« 
- å†…å®¹ A
- å†…å®¹ B
  - å­å†…å®¹ B1
  - å­å†…å®¹ B2
## ç¬¬äºŒç« 
- å†…å®¹ C
- å†…å®¹ D
  - å­å†…å®¹ D1
        `);
        
        const svg = document.querySelector('#mindmap');
        view = Markmap.create(svg, {
          duration: 500,
          maxWidth: 300,
          initialExpandLevel: 3
        });
        
        await view.setData(root);
        await view.fit();
        
        log('âœ… Markmap åˆå§‹åŒ–æˆåŠŸ', 'success');
        log('state.rect: ' + JSON.stringify(view.state.rect));
      } catch (error) {
        log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    });
    
    function testSVGExport() {
      if (!view) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Markmap', 'error');
        return;
      }
      
      try {
        log('å¼€å§‹ SVG å¯¼å‡ºæµ‹è¯•...');
        const svgString = view.exportAsSVG();
        
        log(`âœ… SVG å¯¼å‡ºæˆåŠŸï¼Œé•¿åº¦: ${svgString.length} å­—ç¬¦`, 'success');
        log(`SVG å‰ 200 å­—ç¬¦: ${svgString.substring(0, 200)}...`);
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview');
        preview.innerHTML = '<h3>SVG é¢„è§ˆ:</h3>';
        const img = document.createElement('img');
        const blob = new Blob([svgString], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        img.src = url;
        img.onload = () => {
          log('âœ… SVG é¢„è§ˆåŠ è½½æˆåŠŸ', 'success');
        };
        img.onerror = () => {
          log('âŒ SVG é¢„è§ˆåŠ è½½å¤±è´¥', 'error');
        };
        preview.appendChild(img);
        
      } catch (error) {
        log('âŒ SVG å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    }
    
    async function testPNGExport() {
      if (!view) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Markmap', 'error');
        return;
      }
      
      try {
        log('å¼€å§‹ PNG å¯¼å‡ºæµ‹è¯•...');
        log('state.rect: ' + JSON.stringify(view.state.rect));
        
        const pngBlob = await view.exportAsPNG();
        
        log(`âœ… PNG å¯¼å‡ºæˆåŠŸï¼Œå¤§å°: ${(pngBlob.size / 1024).toFixed(2)} KB`, 'success');
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview');
        preview.innerHTML = '<h3>PNG é¢„è§ˆ:</h3>';
        const img = document.createElement('img');
        const url = URL.createObjectURL(pngBlob);
        img.src = url;
        img.onload = () => {
          log('âœ… PNG é¢„è§ˆåŠ è½½æˆåŠŸ', 'success');
          log(`å›¾ç‰‡å°ºå¯¸: ${img.naturalWidth} x ${img.naturalHeight}`);
        };
        img.onerror = () => {
          log('âŒ PNG é¢„è§ˆåŠ è½½å¤±è´¥', 'error');
        };
        preview.appendChild(img);
        
      } catch (error) {
        log('âŒ PNG å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    }
    
    function testMarkdownExport() {
      if (!view) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Markmap', 'error');
        return;
      }
      
      try {
        log('å¼€å§‹ Markdown å¯¼å‡ºæµ‹è¯•...');
        const markdown = view.exportAsMarkdown();
        
        log(`âœ… Markdown å¯¼å‡ºæˆåŠŸï¼Œé•¿åº¦: ${markdown.length} å­—ç¬¦`, 'success');
        log('Markdown å†…å®¹:');
        log(markdown);
        
      } catch (error) {
        log('âŒ Markdown å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    }
    
    function downloadSVG() {
      if (!view) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Markmap', 'error');
        return;
      }
      
      try {
        view.downloadAsSVG('test-export.svg');
        log('âœ… SVG ä¸‹è½½å·²è§¦å‘', 'success');
      } catch (error) {
        log('âŒ SVG ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    async function downloadPNG() {
      if (!view) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Markmap', 'error');
        return;
      }
      
      try {
        log('å¼€å§‹ä¸‹è½½ PNG...');
        const pngBlob = await view.exportAsPNG();
        const url = URL.createObjectURL(pngBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'test-export.png';
        a.click();
        URL.revokeObjectURL(url);
        log('âœ… PNG ä¸‹è½½å·²è§¦å‘', 'success');
      } catch (error) {
        log('âŒ PNG ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
