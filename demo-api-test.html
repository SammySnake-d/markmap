<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markmap API å®Œæ•´æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }
    
    #sidebar {
      width: 350px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #sidebar-header {
      padding: 20px;
      background: #5e6ad2;
      color: white;
    }
    
    #sidebar-header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    #sidebar-header p {
      font-size: 13px;
      opacity: 0.9;
    }
    
    #test-controls {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    #test-controls button {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #test-controls button.primary {
      background: #5e6ad2;
      color: white;
    }
    
    #test-controls button.primary:hover {
      background: #4c5bc7;
    }
    
    #test-controls button.secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    #test-controls button.secondary:hover {
      background: #e0e0e0;
    }
    
    #test-results {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .test-item {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .test-item.pending {
      background: #f5f5f5;
      color: #666;
    }
    
    .test-item.running {
      background: #fff3cd;
      color: #856404;
      animation: pulse 1s infinite;
    }
    
    .test-item.success {
      background: #d4edda;
      color: #155724;
    }
    
    .test-item.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .test-item .icon {
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .test-item .details {
      flex: 1;
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.8;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    #mindmap-container {
      flex: 1;
      position: relative;
    }
    
    #mindmap {
      width: 100%;
      height: 100%;
    }
    
    #stats {
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 30px;
      font-size: 13px;
    }
    
    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-label {
      color: #666;
    }
    
    .stat-value {
      font-weight: 600;
      color: #333;
    }
    
    .stat-value.success {
      color: #28a745;
    }
    
    .stat-value.error {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="sidebar-header">
      <h1>ğŸ§ª API æµ‹è¯•å¥—ä»¶</h1>
      <p>æµ‹è¯•é‡æ„åçš„ Markmap API</p>
    </div>
    
    <div id="test-controls">
      <button class="primary" onclick="runAllTests()">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <button class="secondary" onclick="clearResults()">ğŸ”„ æ¸…é™¤ç»“æœ</button>
      <button class="secondary" onclick="exportResults()">ğŸ“‹ å¯¼å‡ºç»“æœ</button>
    </div>
    
    <div id="test-results"></div>
  </div>
  
  <div id="main-content">
    <div id="mindmap-container">
      <svg id="mindmap"></svg>
    </div>
    
    <div id="stats">
      <div class="stat">
        <span class="stat-label">æ€»è®¡:</span>
        <span class="stat-value" id="stat-total">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">é€šè¿‡:</span>
        <span class="stat-value success" id="stat-success">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">å¤±è´¥:</span>
        <span class="stat-value error" id="stat-error">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">è€—æ—¶:</span>
        <span class="stat-value" id="stat-time">0ms</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="./packages/markmap-lib/dist/browser/index.iife.js"></script>
  <script src="./packages/markmap-view/dist/browser/index.js"></script>
  
  <script>
    let view;
    let testResults = [];
    let startTime;
    
    const tests = [
      {
        name: 'åˆå§‹åŒ– Markmap',
        fn: async () => {
          const { Transformer, Markmap } = window.markmap;
          const transformer = new Transformer();
          const { root } = transformer.transform(`# æµ‹è¯•\n## å­èŠ‚ç‚¹ 1\n## å­èŠ‚ç‚¹ 2`);
          
          const svg = document.querySelector('#mindmap');
          view = Markmap.create(svg, {
            duration: 300,
            maxWidth: 300,
            initialExpandLevel: 3
          });
          
          await view.setData(root);
          return view !== null;
        }
      },
      {
        name: 'view.state.data - è®¿é—®æ•°æ®',
        fn: async () => {
          return view.state.data !== null && view.state.data !== undefined;
        }
      },
      {
        name: 'view.fit() - é€‚åº”è§†å›¾',
        fn: async () => {
          await view.fit();
          return true;
        }
      },
      {
        name: 'view.rescale() - ç¼©æ”¾',
        fn: async () => {
          await view.rescale(1.2);
          await new Promise(r => setTimeout(r, 300));
          await view.rescale(1.0);
          return true;
        }
      },
      {
        name: 'view.setOptions() - è®¾ç½®é€‰é¡¹',
        fn: async () => {
          view.setOptions({ duration: 200 });
          return view.options.duration === 200;
        }
      },
      {
        name: 'view.exportAsMarkdown() - å¯¼å‡º Markdown',
        fn: async () => {
          const markdown = view.exportAsMarkdown();
          return markdown.includes('#') && markdown.length > 0;
        }
      },
      {
        name: 'view.exportAsSVG() - å¯¼å‡º SVG',
        fn: async () => {
          const svg = view.exportAsSVG();
          return svg.includes('<svg') && svg.includes('</svg>');
        }
      },
      {
        name: 'view.setMarkdownContent() - è®¾ç½®å†…å®¹',
        fn: async () => {
          view.setMarkdownContent('# Test');
          return view.getMarkdownContent() === '# Test';
        }
      },
      {
        name: 'view.getMarkdownContent() - è·å–å†…å®¹',
        fn: async () => {
          const content = view.getMarkdownContent();
          return typeof content === 'string';
        }
      },
      {
        name: 'view.getContainer() - è·å–å®¹å™¨',
        fn: async () => {
          const container = view.getContainer();
          return container !== null && typeof container.resolve === 'function';
        }
      },
      {
        name: 'view.getEventEmitter() - è·å–äº‹ä»¶å‘å°„å™¨',
        fn: async () => {
          const emitter = view.getEventEmitter();
          return emitter !== null && typeof emitter.on === 'function';
        }
      },
      {
        name: 'view.expandAll() - å±•å¼€æ‰€æœ‰',
        fn: async () => {
          if (view.state.data) {
            view.expandAll(view.state.data);
            await new Promise(r => setTimeout(r, 300));
            return true;
          }
          return false;
        }
      },
      {
        name: 'view.collapseAll() - æŠ˜å æ‰€æœ‰',
        fn: async () => {
          if (view.state.data) {
            view.collapseAll(view.state.data);
            await new Promise(r => setTimeout(r, 300));
            return true;
          }
          return false;
        }
      },
      {
        name: 'view.toggleNode() - åˆ‡æ¢èŠ‚ç‚¹',
        fn: async () => {
          if (view.state.data && view.state.data.children && view.state.data.children[0]) {
            view.toggleNode(view.state.data.children[0]);
            await new Promise(r => setTimeout(r, 300));
            return true;
          }
          return false;
        }
      },
      {
        name: 'view.ensureVisible() - ç¡®ä¿å¯è§',
        fn: async () => {
          if (view.state.data) {
            await view.ensureVisible(view.state.data);
            return true;
          }
          return false;
        }
      },
      {
        name: 'view.centerNode() - å±…ä¸­èŠ‚ç‚¹',
        fn: async () => {
          if (view.state.data) {
            await view.centerNode(view.state.data);
            return true;
          }
          return false;
        }
      },
      {
        name: 'view.adjustViewportIfNeeded() - è°ƒæ•´è§†å£',
        fn: async () => {
          await view.adjustViewportIfNeeded();
          return true;
        }
      },
      {
        name: 'view.applyColorSchemeWithAnimation() - åº”ç”¨é…è‰²',
        fn: async () => {
          const colorFn = (node) => {
            if (!node) return '#5e6ad2'; // é»˜è®¤é¢œè‰²
            const colors = ['#5e6ad2', '#26b5ce', '#f9c52a'];
            const depth = node.state?.depth ?? node.depth ?? 0;
            return colors[depth % colors.length];
          };
          view.applyColorSchemeWithAnimation(colorFn);
          await new Promise(r => setTimeout(r, 300));
          return true;
        }
      },
      {
        name: 'äº‹ä»¶ç›‘å¬ - EventEmitter',
        fn: async () => {
          const emitter = view.getEventEmitter();
          // æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦å¯ä»¥æ³¨å†Œ
          let eventFired = false;
          emitter.on('test:event', () => {
            eventFired = true;
          });
          emitter.emit('test:event');
          return eventFired;
        }
      },
      {
        name: 'view.destroy() - é”€æ¯å®ä¾‹',
        fn: async () => {
          // ä¸å®é™…é”€æ¯ï¼Œåªæµ‹è¯•æ–¹æ³•å­˜åœ¨
          return typeof view.destroy === 'function';
        }
      }
    ];
    
    function updateStats() {
      const total = testResults.length;
      const success = testResults.filter(r => r.status === 'success').length;
      const error = testResults.filter(r => r.status === 'error').length;
      const elapsed = Date.now() - startTime;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-success').textContent = success;
      document.getElementById('stat-error').textContent = error;
      document.getElementById('stat-time').textContent = elapsed + 'ms';
    }
    
    function renderTestItem(test, index) {
      const result = testResults[index];
      const status = result ? result.status : 'pending';
      
      const icons = {
        pending: 'â¸ï¸',
        running: 'â³',
        success: 'âœ…',
        error: 'âŒ'
      };
      
      return `
        <div class="test-item ${status}" id="test-${index}">
          <span class="icon">${icons[status]}</span>
          <div style="flex: 1;">
            <div>${test.name}</div>
            ${result && result.error ? `<div class="details">é”™è¯¯: ${result.error}</div>` : ''}
            ${result && result.time ? `<div class="details">è€—æ—¶: ${result.time}ms</div>` : ''}
          </div>
        </div>
      `;
    }
    
    function renderResults() {
      const container = document.getElementById('test-results');
      container.innerHTML = tests.map((test, index) => renderTestItem(test, index)).join('');
    }
    
    async function runAllTests() {
      testResults = [];
      startTime = Date.now();
      renderResults();
      updateStats();
      
      for (let i = 0; i < tests.length; i++) {
        const test = tests[i];
        const testElement = document.getElementById(`test-${i}`);
        
        // æ ‡è®°ä¸ºè¿è¡Œä¸­
        testElement.className = 'test-item running';
        testElement.querySelector('.icon').textContent = 'â³';
        
        const testStart = Date.now();
        
        try {
          const result = await test.fn();
          const testTime = Date.now() - testStart;
          
          if (result) {
            testResults[i] = { status: 'success', time: testTime };
            testElement.className = 'test-item success';
            testElement.querySelector('.icon').textContent = 'âœ…';
            
            const details = document.createElement('div');
            details.className = 'details';
            details.textContent = `è€—æ—¶: ${testTime}ms`;
            testElement.querySelector('div').appendChild(details);
          } else {
            throw new Error('æµ‹è¯•è¿”å› false');
          }
        } catch (error) {
          const testTime = Date.now() - testStart;
          testResults[i] = { status: 'error', error: error.message, time: testTime };
          testElement.className = 'test-item error';
          testElement.querySelector('.icon').textContent = 'âŒ';
          
          const details = document.createElement('div');
          details.className = 'details';
          details.textContent = `é”™è¯¯: ${error.message}`;
          testElement.querySelector('div').appendChild(details);
          
          console.error(`æµ‹è¯•å¤±è´¥: ${test.name}`, error);
        }
        
        updateStats();
        
        // çŸ­æš‚å»¶è¿Ÿï¼Œè®©åŠ¨ç”»æ›´æ˜æ˜¾
        await new Promise(r => setTimeout(r, 100));
      }
      
      console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', testResults);
    }
    
    function clearResults() {
      testResults = [];
      renderResults();
      updateStats();
    }
    
    function exportResults() {
      const report = {
        timestamp: new Date().toISOString(),
        total: tests.length,
        passed: testResults.filter(r => r.status === 'success').length,
        failed: testResults.filter(r => r.status === 'error').length,
        duration: Date.now() - startTime,
        tests: tests.map((test, i) => ({
          name: test.name,
          ...testResults[i]
        }))
      };
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `markmap-api-test-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      renderResults();
      console.log('API æµ‹è¯•å¥—ä»¶å·²åŠ è½½');
      console.log('ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
    });
  </script>
</body>
</html>
