<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NotePanel 编辑模式测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .test-section h2 {
      color: #666;
      font-size: 18px;
      margin-bottom: 15px;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #357abd;
    }
    .info {
      margin-top: 15px;
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      border-radius: 4px;
      font-size: 14px;
    }
    #test-container {
      position: relative;
      min-height: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📝 NotePanel 编辑模式与实时保存测试</h1>
    
    <div class="test-section">
      <h2>测试说明</h2>
      <p>这个页面用于测试 NotePanel 的编辑模式和实时保存功能（任务 42 & 44）。</p>
      <div class="info">
        <strong>功能要求（需求 5.7）：</strong><br>
        WHEN 备注面板展开 THEN 思维导图系统 SHALL 允许用户直接编辑单行备注和详细备注内容
        <br><br>
        <strong>功能要求（需求 5.8）：</strong><br>
        WHEN 用户编辑备注内容 THEN 思维导图系统 SHALL 实时自动保存更改到原始 Markdown 数据
      </div>
    </div>

    <div class="test-section">
      <h2>测试用例</h2>
      <button onclick="testCase1()">测试 1: 显示带单行备注的面板</button>
      <button onclick="testCase2()">测试 2: 显示带详细备注的面板</button>
      <button onclick="testCase3()">测试 3: 显示带两种备注的面板</button>
      <button onclick="testCase4()">测试 4: 显示无备注的面板</button>
    </div>

    <div class="test-section">
      <h2>操作说明</h2>
      <ol>
        <li>点击上方按钮显示备注面板</li>
        <li>点击面板中的 ✏️ 按钮进入编辑模式</li>
        <li>修改备注内容（开始输入）</li>
        <li>观察控制台 - 应在停止输入 500ms 后自动保存</li>
        <li>或者点击 ✓ 按钮或点击外部立即保存</li>
        <li>查看控制台输出的保存信息</li>
      </ol>
      <div class="info">
        <strong>预期行为：</strong><br>
        • 点击编辑按钮后，备注内容应变为可编辑的文本框<br>
        • 编辑按钮图标应从 ✏️ 变为 ✓<br>
        • <strong>【实时保存】</strong>输入时，系统会在停止输入 500ms 后自动保存（防抖）<br>
        • <strong>【实时保存】</strong>失去焦点时会立即保存，取消待处理的自动保存<br>
        • 完成编辑后，内容应保存并显示在控制台<br>
        • 切换到新节点时，编辑模式应自动重置
      </div>
    </div>

    <div id="test-container"></div>
  </div>

  <script type="module">
    import { NotePanel } from './src/note-panel.js';

    // 创建测试容器
    const container = document.getElementById('test-container');
    const notePanel = new NotePanel(container);

    // 设置回调
    let saveCount = 0;
    notePanel.onEdit = (node, inlineNote, detailedNote) => {
      saveCount++;
      const timestamp = new Date().toLocaleTimeString();
      console.log(`✅ [${timestamp}] 备注已保存 (第 ${saveCount} 次):`);
      console.log('  节点:', node.content);
      console.log('  单行备注:', inlineNote);
      console.log('  详细备注:', detailedNote);
      console.log('  ---');
      
      // 显示一个小提示而不是弹窗，避免打断输入
      const notification = document.createElement('div');
      notification.textContent = `✅ 自动保存成功 (${timestamp})`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    };

    notePanel.onClose = () => {
      console.log('📪 面板已关闭');
    };

    // 测试用例
    window.testCase1 = () => {
      console.log('🧪 测试用例 1: 单行备注');
      const node = {
        content: '测试节点 1',
        inlineNote: '这是一个单行备注',
        hasNote: true,
        children: [],
        payload: {},
        state: undefined
      };
      notePanel.show(node, { x: 300, y: 200 });
    };

    window.testCase2 = () => {
      console.log('🧪 测试用例 2: 详细备注');
      const node = {
        content: '测试节点 2',
        detailedNote: '这是一个详细备注\n\n包含多行内容\n- 列表项 1\n- 列表项 2\n\n还有 **粗体** 和 *斜体*',
        hasNote: true,
        children: [],
        payload: {},
        state: undefined
      };
      notePanel.show(node, { x: 300, y: 200 });
    };

    window.testCase3 = () => {
      console.log('🧪 测试用例 3: 两种备注');
      const node = {
        content: '测试节点 3',
        inlineNote: '简短说明',
        detailedNote: '详细说明：\n\n这个节点同时包含单行备注和详细备注。\n\n**重要提示：** 两种备注都可以编辑。',
        hasNote: true,
        children: [],
        payload: {},
        state: undefined
      };
      notePanel.show(node, { x: 300, y: 200 });
    };

    window.testCase4 = () => {
      console.log('🧪 测试用例 4: 无备注');
      const node = {
        content: '测试节点 4',
        hasNote: false,
        children: [],
        payload: {},
        state: undefined
      };
      notePanel.show(node, { x: 300, y: 200 });
    };

    console.log('✅ NotePanel 编辑模式与实时保存测试页面已加载');
    console.log('💡 提示: 点击页面上的按钮开始测试');
    console.log('');
    console.log('🔍 实时保存测试要点:');
    console.log('  1. 进入编辑模式后开始输入');
    console.log('  2. 停止输入 500ms 后会自动保存');
    console.log('  3. 快速连续输入时，只会在最后一次输入后 500ms 保存一次');
    console.log('  4. 失去焦点（blur）时会立即保存');
    console.log('  5. 关闭面板会取消待处理的自动保存');
  </script>
</body>
</html>
