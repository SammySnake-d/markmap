<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markmap Enhanced æµ‹è¯•å¹³å° (é‡æ„ç‰ˆ)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      display: flex;
      height: 100vh;
    }
    
    /* å·¦ä¾§ç¼–è¾‘å™¨ */
    #editor-panel {
      width: 40%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
      background: #f9f9f9;
    }
    
    #editor-header {
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #editor-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }
    
    #editor-header button {
      padding: 6px 12px;
      border: 1px solid #5e6ad2;
      background: #5e6ad2;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
    
    #editor-header button:hover {
      background: #4c5bc7;
    }
    
    #editor-header .secondary {
      background: white;
      color: #5e6ad2;
    }
    
    #editor-header .secondary:hover {
      background: #f5f5f5;
    }
    
    #markdown-input {
      flex: 1;
      padding: 20px;
      border: none;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: none;
      background: white;
      margin: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #markdown-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1);
    }
    
    /* å³ä¾§é¢„è§ˆ */
    #preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    #preview-header {
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #preview-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }
    
    #preview-header button {
      padding: 6px 12px;
      border: 1px solid #d0d0d0;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    #preview-header button:hover {
      background: #f5f5f5;
    }
    
    #mindmap {
      flex: 1;
      width: 100%;
      height: 100%;
    }
    
    /* ç¤ºä¾‹æ¨¡æ¿ */
    #templates {
      padding: 10px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    #templates label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }
    
    #templates button {
      padding: 4px 10px;
      border: 1px solid #d0d0d0;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    #templates button:hover {
      background: #e8e8e8;
    }
    
    /* çŠ¶æ€æç¤º */
    #status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10000;
      max-width: 400px;
    }
    
    #status.success {
      border-color: #52c41a;
      background: #f6ffed;
      color: #52c41a;
    }
    
    #status.error {
      border-color: #ff4d4f;
      background: #fff2f0;
      color: #ff4d4f;
    }
    
    /* å¤‡æ³¨åŠŸèƒ½æç¤º */
    #note-tip {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      padding: 16px 20px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      z-index: 9999;
      max-width: 320px;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    #note-tip h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
      font-weight: 600;
    }
    
    #note-tip p {
      margin: 4px 0;
      line-height: 1.5;
      opacity: 0.95;
    }
    
    #note-tip button {
      margin-top: 12px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    #note-tip button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    /* å¤‡æ³¨å›¾æ ‡æ ·å¼ */
    .markmap-note-icon {
      cursor: pointer;
      user-select: none;
      transition: opacity 0.2s, transform 0.2s;
    }
    
    .markmap-note-icon:hover {
      opacity: 1 !important;
      transform: scale(1.2);
    }
    
    /* å¤‡æ³¨é¢æ¿æ ·å¼ */
    .markmap-note-panel {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .markmap-note-panel input:focus,
    .markmap-note-panel textarea:focus {
      outline: none;
      border-color: #5e6ad2;
      box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1);
    }
    
    .note-panel-close:hover {
      color: #333;
      background: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§ç¼–è¾‘å™¨ -->
  <div id="editor-panel">
    <div id="editor-header">
      <h2>ğŸ“ Markdown ç¼–è¾‘å™¨ (é‡æ„ç‰ˆ)</h2>
      <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
      <button onclick="renderMarkdown()">ğŸš€ æ¸²æŸ“</button>
    </div>
    
    <div id="templates">
      <label>å¿«é€Ÿæ¨¡æ¿:</label>
      <button onclick="loadTemplate('basic')">åŸºç¡€ç¤ºä¾‹</button>
      <button onclick="loadTemplate('notes')">å¤‡æ³¨æµ‹è¯•</button>
      <button onclick="loadTemplate('mixed')">æ··åˆè¯­æ³•</button>
      <button onclick="loadTemplate('complex')">å¤æ‚ç»“æ„</button>
      <button onclick="loadTemplate('edge')">è¾¹ç¼˜æƒ…å†µ</button>
    </div>
    
    <textarea id="markdown-input" placeholder="åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹...&#10;&#10;æ”¯æŒçš„è¯­æ³•:&#10;- æ ‡é¢˜: # ## ### #### ##### ######&#10;- åˆ—è¡¨: - æˆ– *&#10;- å¤‡æ³¨: ä½¿ç”¨å†’å· (:) åˆ†éš”&#10;- è¯¦ç»†å¤‡æ³¨: ä½¿ç”¨å¼•ç”¨å— (>)&#10;&#10;ç‚¹å‡»å³ä¸Šè§’çš„"æ¸²æŸ“"æŒ‰é’®æŸ¥çœ‹æ•ˆæœ"></textarea>
  </div>
  
  <!-- å³ä¾§é¢„è§ˆ -->
  <div id="preview-panel">
    <div id="preview-header">
      <h2>ğŸ¨ æ€ç»´å¯¼å›¾é¢„è§ˆ (é‡æ„ç‰ˆ)</h2>
      <select id="color-scheme" onchange="changeColorScheme()" style="padding: 6px 12px; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 13px; cursor: pointer;">
        <option value="default">é»˜è®¤é…è‰²</option>
        <option value="ocean">æµ·æ´‹é£æ ¼</option>
        <option value="forest">æ£®æ—é£æ ¼</option>
        <option value="sunset">æ—¥è½é£æ ¼</option>
        <option value="monochrome">å•è‰²é£æ ¼</option>
      </select>
      <button onclick="fitView()">ğŸ¯ é€‚åº”è§†å›¾</button>
      <button onclick="copyAsMarkdown()">ğŸ“‹ å¤åˆ¶ Markdown</button>
      <button onclick="exportImage()">ğŸ’¾ å¯¼å‡ºå›¾ç‰‡</button>
      <button onclick="diagnoseNotes()" style="background: #f0f0f0; color: #666;">ğŸ” è¯Šæ–­å¤‡æ³¨</button>
    </div>
    
    <svg id="mindmap"></svg>
  </div>
  
  <div id="status" style="display: none;"></div>
  
  <!-- å¤‡æ³¨åŠŸèƒ½æç¤º -->
  <div id="note-tip" style="display: none;">
    <h3>ğŸ“ å¤‡æ³¨åŠŸèƒ½å·²å¯ç”¨</h3>
    <p>âœ¨ ç‚¹å‡»èŠ‚ç‚¹æ—çš„ ğŸ“ å›¾æ ‡å¯ä»¥æ·»åŠ å¤‡æ³¨</p>
    <p>ğŸ’¡ æ”¯æŒå¤šè¡Œæ–‡æœ¬å’Œè‡ªåŠ¨ä¿å­˜</p>
    <p>ğŸ¯ è¯•è¯•"å¤‡æ³¨æµ‹è¯•"æ¨¡æ¿æŸ¥çœ‹ç¤ºä¾‹</p>
    <button onclick="document.getElementById('note-tip').style.display='none'">çŸ¥é“äº†</button>
  </div>

  <!-- åŠ è½½ D3.js -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  
  <!-- åŠ è½½ markmap åº“ -->
  <script src="./packages/markmap-lib/dist/browser/index.iife.js"></script>
  <!-- æ³¨æ„ï¼šå¦‚æœçœ‹åˆ° handleNoteIconClick é”™è¯¯ï¼Œè¯·æŒ‰ Ctrl+Shift+R (Mac: Cmd+Shift+R) å¼ºåˆ¶åˆ·æ–°æ¸…é™¤ç¼“å­˜ -->
  <script src="./packages/markmap-view/dist/browser/index.js"></script>
  
  <script>
    let view; // ä½¿ç”¨é‡æ„åçš„ view å®ä¾‹
    let currentMarkdown = '';
    
    // æ¨¡æ¿åº“
    const templates = {
      basic: `# åŸºç¡€ç¤ºä¾‹

## ç¬¬ä¸€ç« 
- å†…å®¹ A
- å†…å®¹ B
  - å­å†…å®¹ B1
  - å­å†…å®¹ B2

## ç¬¬äºŒç« 
- å†…å®¹ C
- å†…å®¹ D`,

      notes: `# å¤‡æ³¨åŠŸèƒ½æµ‹è¯• ğŸ“

## ğŸ“Œ å¦‚ä½•ä½¿ç”¨å¤‡æ³¨åŠŸèƒ½
- ç‚¹å‡»èŠ‚ç‚¹æ—è¾¹çš„ ğŸ“ å›¾æ ‡æ‰“å¼€å¤‡æ³¨é¢æ¿
- åœ¨æ–‡æœ¬åŒºåŸŸè¾“å…¥å¤šè¡Œå¤‡æ³¨å†…å®¹
- å¤‡æ³¨ä¼šè‡ªåŠ¨ä¿å­˜
- å†æ¬¡ç‚¹å‡»å›¾æ ‡æˆ–ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­é¢æ¿

## å•è¡Œå¤‡æ³¨ç¤ºä¾‹
- é¡¹ç›®åç§°: Markmap Enhanced
- å¼€å‘è¯­è¨€: TypeScript + D3.js
- ä¼˜å…ˆçº§: P0 æœ€é«˜ä¼˜å…ˆçº§
- çŠ¶æ€: å¼€å‘ä¸­
- è´Ÿè´£äºº: å¼€å‘å›¢é˜Ÿ

## å¤šè¡Œå¤‡æ³¨ç¤ºä¾‹
- éœ€æ±‚åˆ†æ
  > è¿™æ˜¯è¯¦ç»†å¤‡æ³¨çš„ç¬¬ä¸€è¡Œ
  > å¯ä»¥åŒ…å«å¤šè¡Œå†…å®¹
  > æ”¯æŒæ¢è¡Œå’Œæ ¼å¼åŒ–
  > 
  > ç¬¬äºŒæ®µå†…å®¹
  > ç»§ç»­æ·»åŠ æ›´å¤šè¯´æ˜

## æ··åˆå¤‡æ³¨ç¤ºä¾‹
- ç”¨æˆ·è°ƒç ”: ç¬¬ä¸€é˜¶æ®µå®Œæˆ
  > **è°ƒç ”å¯¹è±¡**: ä¼ä¸šç”¨æˆ· 50 äºº
  > **è°ƒç ”æ–¹å¼**: é—®å· + æ·±åº¦è®¿è°ˆ
  > **å…³é”®å‘ç°**:
  > - éœ€è¦å¤‡æ³¨åŠŸèƒ½
  > - éœ€è¦æœç´¢åŠŸèƒ½
  > - éœ€è¦å¯¼å‡ºåŠŸèƒ½

## å®é™…åº”ç”¨åœºæ™¯
- é¡¹ç›®ç®¡ç†: è®°å½•ä»»åŠ¡è¯¦æƒ…å’Œè¿›åº¦
  > **ä»»åŠ¡**: å®ç°å¤‡æ³¨åŠŸèƒ½
  > **æˆªæ­¢æ—¥æœŸ**: 2024-12-31
  > **ä¼˜å…ˆçº§**: é«˜
  > **å¤‡æ³¨**: éœ€è¦æ”¯æŒå¤šè¡Œæ–‡æœ¬å’Œè‡ªåŠ¨ä¿å­˜
- çŸ¥è¯†ç®¡ç†: æ·»åŠ å­¦ä¹ ç¬”è®°å’Œå¿ƒå¾—
  > å­¦ä¹ è¦ç‚¹æ€»ç»“
  > é‡è¦æ¦‚å¿µè§£é‡Š
  > ç›¸å…³èµ„æºé“¾æ¥
- ä¼šè®®è®°å½•: è®°å½•è®¨è®ºè¦ç‚¹å’Œå†³ç­–
  > ä¼šè®®æ—¶é—´: 2024-01-15 14:00
  > å‚ä¼šäººå‘˜: å¼ ä¸‰ã€æå››ã€ç‹äº”
  > è®¨è®ºè®®é¢˜: äº§å“åŠŸèƒ½è§„åˆ’
  > å†³ç­–äº‹é¡¹: ä¼˜å…ˆå¼€å‘å¤‡æ³¨åŠŸèƒ½`,

      mixed: `# æ··åˆè¯­æ³•æµ‹è¯•

## æ ‡é¢˜ä¸åˆ—è¡¨æ··åˆ

### æ•°æ®ç»“æ„
- æ•°ç»„ (Array)
  - é™æ€æ•°ç»„
  - åŠ¨æ€æ•°ç»„
- é“¾è¡¨ (Linked List)
  - å•å‘é“¾è¡¨
  - åŒå‘é“¾è¡¨

### ç®—æ³•
- æ’åºç®—æ³•
  - å†’æ³¡æ’åº
  - å¿«é€Ÿæ’åº
- æœç´¢ç®—æ³•
  - äºŒåˆ†æœç´¢
  - æ·±åº¦ä¼˜å…ˆæœç´¢

## çº¯åˆ—è¡¨ç»“æ„

- ç¬¬ä¸€å±‚ A
  - ç¬¬äºŒå±‚ A1
    - ç¬¬ä¸‰å±‚ A1a
  - ç¬¬äºŒå±‚ A2
- ç¬¬ä¸€å±‚ B`,

      complex: `# å¤æ‚ç»“æ„æµ‹è¯•

## æ·±å±‚åµŒå¥—

### ä¸‰çº§æ ‡é¢˜

#### å››çº§æ ‡é¢˜

##### äº”çº§æ ‡é¢˜

###### å…­çº§æ ‡é¢˜
- å…­çº§æ ‡é¢˜ä¸‹çš„åˆ—è¡¨
  - åµŒå¥—åˆ—è¡¨
    - æ›´æ·±å±‚åµŒå¥—
      - ç¬¬å››å±‚
        - ç¬¬äº”å±‚

## ç‰¹æ®Šå­—ç¬¦

- åŒ…å«å†’å·: 14:30 ä¼šè®®æ—¶é—´
- åŒ…å« emoji: ğŸ‰ åº†ç¥
- è½¬ä¹‰æµ‹è¯•\\: è¿™æ˜¯å¤‡æ³¨
- URL æµ‹è¯•: https://example.com
- ä»£ç : \`const x = 1\`

## é•¿æ–‡æœ¬æµ‹è¯•

- è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„æ–‡æœ¬å†…å®¹ï¼Œç”¨æ¥æµ‹è¯•èŠ‚ç‚¹åœ¨åŒ…å«å¤§é‡æ–‡å­—æ—¶çš„æ˜¾ç¤ºæ•ˆæœï¼Œçœ‹çœ‹æ˜¯å¦ä¼šæ­£ç¡®æ¢è¡Œå’Œå¸ƒå±€: è¿™æ˜¯å¤‡æ³¨éƒ¨åˆ†ï¼Œä¹ŸåŒ…å«å¾ˆå¤šæ–‡å­—
  > è¿™æ˜¯è¯¦ç»†å¤‡æ³¨ï¼ŒåŒ…å«æ›´å¤šçš„è¯´æ˜ä¿¡æ¯
  > å¯ä»¥æœ‰å¤šè¡Œå†…å®¹
  > æµ‹è¯•é•¿æ–‡æœ¬çš„æ¸²æŸ“æ•ˆæœ`,

      edge: `# è¾¹ç¼˜æƒ…å†µæµ‹è¯•

## ç©ºå†…å®¹æµ‹è¯•
-
- 
  - 

## ç‰¹æ®Šæ ¼å¼
- **ç²—ä½“æ–‡æœ¬**: è¿™æ˜¯å¤‡æ³¨
- *æ–œä½“æ–‡æœ¬*: è¿™æ˜¯å¤‡æ³¨
- \`ä»£ç æ–‡æœ¬\`: è¿™æ˜¯å¤‡æ³¨

## å¤šä¸ªå†’å·
- æ—¶é—´: 14:30:45
- æ¯”ä¾‹: 1:2:3
- URL: http://example.com:8080

## è¿ç»­å¤‡æ³¨å—
- æµ‹è¯•é¡¹
  > ç¬¬ä¸€ä¸ªå¤‡æ³¨å—
  > ç¬¬äºŒè¡Œ
  > ç¬¬ä¸‰è¡Œ

## ç©ºå¤‡æ³¨
- æœ‰å†’å·ä½†æ— å¤‡æ³¨:
- æœ‰å¤‡æ³¨å—ä½†ä¸ºç©º
  >

## Unicode æµ‹è¯•
- ä¸­æ–‡: æµ‹è¯•ä¸­æ–‡å¤‡æ³¨
- æ—¥æ–‡: ãƒ†ã‚¹ãƒˆ
- Emoji: ğŸš€ ğŸ¨ ğŸ“ âœ…
- ç‰¹æ®Šç¬¦å·: Â©ï¸ Â®ï¸ â„¢ï¸`
    };
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type = 'success') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
      status.style.display = 'block';
      
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }
    
    // åŠ è½½æ¨¡æ¿
    function loadTemplate(name) {
      const input = document.getElementById('markdown-input');
      input.value = templates[name] || '';
      showStatus(`å·²åŠ è½½"${name}"æ¨¡æ¿`);
    }
    
    // æ¸…ç©ºç¼–è¾‘å™¨
    function clearEditor() {
      document.getElementById('markdown-input').value = '';
      showStatus('ç¼–è¾‘å™¨å·²æ¸…ç©º');
    }
    
    // æ¸²æŸ“ Markdown
    async function renderMarkdown() {
      try {
        const markdown = document.getElementById('markdown-input').value;
        
        if (!markdown.trim()) {
          showStatus('è¯·è¾“å…¥ Markdown å†…å®¹', 'error');
          return;
        }
        
        currentMarkdown = markdown;
        
        const { Transformer, Markmap } = window.markmap;
        
        // åˆ›å»º transformer
        const transformer = new Transformer();
        
        // è§£æ markdown
        const { root } = transformer.transform(markdown);
        
        console.log('è§£æç»“æœ:', root);
        
        // å¦‚æœå·²æœ‰ markmap å®ä¾‹ï¼Œæ›´æ–°æ•°æ®
        if (view) {
          await view.setData(root);
        } else {
          // åˆ›å»ºæ–°çš„ markmap å®ä¾‹
          const svg = document.querySelector('#mindmap');
          
          view = Markmap.create(svg, {
            duration: 500,
            maxWidth: 300,
            initialExpandLevel: 3,
            paddingX: 80,
            paddingY: 20,
            spacingHorizontal: 80,
            spacingVertical: 20,
            autoFit: true,
            fitRatio: 0.95
          });
          
          await view.setData(root);
          
          // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
          const emitter = view.getEventEmitter();
          
          emitter.on('node:click', (node) => {
            console.log('èŠ‚ç‚¹è¢«ç‚¹å‡»:', node);
          });
          
          emitter.on('view:fit', () => {
            console.log('è§†å›¾å·²é€‚åº”');
          });
        }
        
        // å»¶è¿Ÿè°ƒç”¨ fit ç¡®ä¿å¸ƒå±€å®Œæˆ
        setTimeout(() => {
          view.fit();
        }, 100);
        
        showStatus('âœ… æ¸²æŸ“æˆåŠŸï¼');
        
      } catch (error) {
        console.error('æ¸²æŸ“å¤±è´¥:', error);
        showStatus('âŒ æ¸²æŸ“å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // é€‚åº”è§†å›¾
    async function fitView() {
      if (view) {
        await view.fit();
        showStatus('è§†å›¾å·²é€‚åº”');
      } else {
        showStatus('è¯·å…ˆæ¸²æŸ“ Markdown', 'error');
      }
    }
    
    // åˆ‡æ¢é¢œè‰²æ–¹æ¡ˆ
    function changeColorScheme() {
      if (!view) {
        showStatus('è¯·å…ˆæ¸²æŸ“ Markdown', 'error');
        return;
      }
      
      const select = document.getElementById('color-scheme');
      const schemeName = select.value;
      
      // é¢œè‰²æ–¹æ¡ˆå®šä¹‰
      const colorSchemes = {
        default: ['#5e6ad2', '#26b5ce', '#f9c52a', '#f98e52', '#e55e5e'],
        ocean: ['#006d77', '#83c5be', '#edf6f9', '#ffddd2', '#e29578'],
        forest: ['#2d6a4f', '#40916c', '#52b788', '#74c69d', '#95d5b2'],
        sunset: ['#ff6b6b', '#ee5a6f', '#c44569', '#774c60', '#2d4059'],
        monochrome: ['#2c3e50', '#34495e', '#7f8c8d', '#95a5a6', '#bdc3c7']
      };
      
      const colors = colorSchemes[schemeName];
      
      if (!colors) {
        showStatus('æœªçŸ¥çš„é¢œè‰²æ–¹æ¡ˆ', 'error');
        return;
      }
      
      // åˆ›å»ºé¢œè‰²å‡½æ•°ï¼ˆå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
      const colorFn = (node) => {
        if (!node) return colors[0]; // é»˜è®¤é¢œè‰²
        const depth = node.state?.depth ?? node.depth ?? 0;
        return colors[depth % colors.length];
      };
      
      // åº”ç”¨é¢œè‰²æ–¹æ¡ˆ(å¸¦åŠ¨ç”»)
      view.applyColorSchemeWithAnimation(colorFn);
      
      // æ›´æ–°optionsä¸­çš„colorå‡½æ•°
      view.options.color = colorFn;
      
      // ä¿å­˜åˆ°localStorage
      try {
        localStorage.setItem('markmap-color-scheme', schemeName);
      } catch (e) {
        console.warn('æ— æ³•ä¿å­˜é¢œè‰²æ–¹æ¡ˆ:', e);
      }
      
      showStatus(`âœ… å·²åˆ‡æ¢åˆ°"${select.options[select.selectedIndex].text}"é…è‰²`);
    }
    
    // å¤åˆ¶ä¸º Markdown
    function copyAsMarkdown() {
      if (!view || !view.state.data) {
        showStatus('è¯·å…ˆæ¸²æŸ“ Markdown', 'error');
        return;
      }
      
      try {
        // ä½¿ç”¨é‡æ„åçš„ exportAsMarkdown æ–¹æ³•
        const md = view.exportAsMarkdown();
        
        navigator.clipboard.writeText(md).then(() => {
          showStatus('âœ… Markdown å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          showStatus('å¤åˆ¶å¤±è´¥', 'error');
        });
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        showStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å¯¼å‡ºå›¾ç‰‡
    async function exportImage() {
      if (!view) {
        showStatus('è¯·å…ˆæ¸²æŸ“ Markdown', 'error');
        return;
      }
      
      const options = ['PNG', 'SVG'];
      const choice = prompt('é€‰æ‹©å¯¼å‡ºæ ¼å¼:\n1. PNG\n2. SVG\n\nè¯·è¾“å…¥æ•°å­— (1-2):', '1');
      
      if (!choice) return;
      
      const index = parseInt(choice) - 1;
      if (index < 0 || index >= options.length) {
        showStatus('æ— æ•ˆçš„é€‰æ‹©', 'error');
        return;
      }
      
      const format = options[index];
      
      try {
        if (format === 'PNG') {
          // PNG å¯¼å‡º
          if (view.downloadAsPNG) {
            await view.downloadAsPNG();
          } else {
            showStatus('PNG å¯¼å‡ºåŠŸèƒ½æš‚ä¸å¯ç”¨', 'error');
          }
        } else if (format === 'SVG') {
          // SVG å¯¼å‡º
          view.downloadAsSVG('mindmap.svg');
        }
        showStatus(`âœ… æ­£åœ¨å¯¼å‡º ${format} æ ¼å¼...`);
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        showStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // è¯Šæ–­å¤‡æ³¨åŠŸèƒ½
    function diagnoseNotes() {
      console.log('=== å¤‡æ³¨åŠŸèƒ½è¯Šæ–­ ===');
      
      let report = 'ğŸ“‹ å¤‡æ³¨åŠŸèƒ½è¯Šæ–­æŠ¥å‘Š\n\n';
      let hasError = false;
      
      // 1. æ£€æŸ¥ view å®ä¾‹
      if (!view) {
        report += 'âŒ Markmap å®ä¾‹æœªåˆ›å»º\n';
        report += '   è¯·å…ˆç‚¹å‡»"æ¸²æŸ“"æŒ‰é’®\n\n';
        hasError = true;
      } else {
        report += 'âœ… Markmap å®ä¾‹å·²åˆ›å»º\n\n';
        
        // 2. æ£€æŸ¥å…³é”®æ–¹æ³•
        const methods = ['handleNoteIconClick', 'setData', 'fit', 'exportAsMarkdown'];
        report += 'æ–¹æ³•æ£€æŸ¥:\n';
        
        methods.forEach(method => {
          if (typeof view[method] === 'function') {
            report += `  âœ… ${method}\n`;
          } else {
            report += `  âŒ ${method} (ä¸å­˜åœ¨)\n`;
            hasError = true;
          }
        });
        
        report += '\n';
        
        // 3. æ£€æŸ¥ notePanel
        if (view.notePanel) {
          report += 'âœ… notePanel å¯¹è±¡å­˜åœ¨\n';
          
          if (typeof view.notePanel.show === 'function') {
            report += '  âœ… notePanel.show æ–¹æ³•å­˜åœ¨\n';
          } else {
            report += '  âŒ notePanel.show æ–¹æ³•ä¸å­˜åœ¨\n';
            hasError = true;
          }
        } else {
          report += 'âŒ notePanel å¯¹è±¡ä¸å­˜åœ¨\n';
          hasError = true;
        }
        
        report += '\n';
        
        // 4. åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ–¹æ³•
        const allMethods = [];
        for (let key in view) {
          if (typeof view[key] === 'function') {
            allMethods.push(key);
          }
        }
        
        report += `å¯ç”¨æ–¹æ³•æ€»æ•°: ${allMethods.length}\n`;
        report += 'éƒ¨åˆ†æ–¹æ³•åˆ—è¡¨:\n';
        allMethods.slice(0, 10).forEach(m => {
          report += `  - ${m}\n`;
        });
        
        if (allMethods.length > 10) {
          report += `  ... è¿˜æœ‰ ${allMethods.length - 10} ä¸ªæ–¹æ³•\n`;
        }
      }
      
      report += '\n';
      
      // 5. ç»™å‡ºå»ºè®®
      if (hasError) {
        report += 'âš ï¸ å‘ç°é—®é¢˜ï¼\n\n';
        report += 'è§£å†³æ–¹æ¡ˆ:\n';
        report += '1. æŒ‰ Ctrl+Shift+R (Mac: Cmd+Shift+R) å¼ºåˆ¶åˆ·æ–°é¡µé¢\n';
        report += '2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡æ–°åŠ è½½\n';
        report += '3. ä½¿ç”¨æ— ç—•æ¨¡å¼æ‰“å¼€é¡µé¢\n';
        report += '4. æ£€æŸ¥æ„å»ºæ–‡ä»¶æ˜¯å¦æ˜¯æœ€æ–°çš„:\n';
        report += '   cd markmap/packages/markmap-view && pnpm build:js\n';
      } else {
        report += 'âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¤‡æ³¨åŠŸèƒ½åº”è¯¥æ­£å¸¸å·¥ä½œ\n\n';
        report += 'ä½¿ç”¨æ–¹æ³•:\n';
        report += '1. æ¸²æŸ“åŒ…å«å¤‡æ³¨çš„ Markdown\n';
        report += '2. ç‚¹å‡»èŠ‚ç‚¹æ—çš„ ğŸ“ å›¾æ ‡\n';
        report += '3. åœ¨å¼¹å‡ºçš„é¢æ¿ä¸­è¾“å…¥å¤‡æ³¨\n';
      }
      
      console.log(report);
      alert(report);
      
      return !hasError;
    }
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
      if (view) {
        setTimeout(() => {
          view.fit();
        }, 100);
      }
    });
    
    // å¿«æ·é”®æ”¯æŒ
    document.getElementById('markdown-input').addEventListener('keydown', function(e) {
      // Ctrl/Cmd + Enter æ¸²æŸ“
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        renderMarkdown();
      }
      
      // Tab é”®æ’å…¥ç¼©è¿›
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const value = this.value;
        this.value = value.substring(0, start) + '  ' + value.substring(end);
        this.selectionStart = this.selectionEnd = start + 2;
      }
    });
    
    // åˆå§‹åŒ–ï¼šåŠ è½½åŸºç¡€ç¤ºä¾‹
    window.addEventListener('load', function() {
      if (typeof window.markmap === 'undefined') {
        showStatus('Markmap åº“åŠ è½½å¤±è´¥', 'error');
        return;
      }
      
      // åŠ è½½ä¿å­˜çš„é¢œè‰²æ–¹æ¡ˆ
      try {
        const savedScheme = localStorage.getItem('markmap-color-scheme');
        if (savedScheme) {
          const select = document.getElementById('color-scheme');
          select.value = savedScheme;
        }
      } catch (e) {
        console.warn('æ— æ³•åŠ è½½ä¿å­˜çš„é¢œè‰²æ–¹æ¡ˆ:', e);
      }
      
      loadTemplate('basic');
      showStatus('æ¬¢è¿ä½¿ç”¨ Markmap Enhanced æµ‹è¯•å¹³å°ï¼ˆé‡æ„ç‰ˆï¼‰ï¼æŒ‰ Ctrl/Cmd+Enter å¿«é€Ÿæ¸²æŸ“');
      
      // æ˜¾ç¤ºå¤‡æ³¨åŠŸèƒ½æç¤ºï¼ˆ3ç§’åï¼‰
      setTimeout(() => {
        const noteTip = document.getElementById('note-tip');
        if (noteTip) {
          noteTip.style.display = 'block';
          
          // 10ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            noteTip.style.display = 'none';
          }, 10000);
        }
      }, 3000);
    });
  </script>
</body>
</html>
